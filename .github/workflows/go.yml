name: Go Build and Deploy

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  # Job 1: Build and Test
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go environment
        uses: actions/setup-go@v5
        with:
          # Automatically detects 1.25.5 from your go.mod
          go-version-file: 'go.mod'
          cache: true
          cache-dependency-path: 'go.sum'

      - name: Install dependencies
        run: go mod download

      - name: Build
        run: go build -v -o groupie-tracker .

      - name: Run Tests
        run: go test -v ./...

  # Job 2: Build Docker Image and Deploy
  # This only runs if build-and-test passes and we are on the main branch
  deploy:
    needs: build-and-test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          # Replace 'your-username' with your actual Docker Hub username 
          # or use the secret variable as shown below
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/groupie-tracker:latest

---

### Implementation Checklist

To make this "finished" script actually work, ensure you have completed these three steps:

1.  **The Dockerfile:** You **must** have a file named `Dockerfile` in your root directory (as provided in the previous response) so that your templates and static files are included in the deployment.
2.  **GitHub Secrets:** Go to your GitHub repository → **Settings** → **Secrets and variables** → **Actions** and add:
    * `DOCKERHUB_USERNAME`: Your Docker Hub account name.
    * `DOCKERHUB_TOKEN`: Your Docker Hub access token (Personal Access Token).
3.  **Go Files:** Ensure your `go.mod` and `go.sum` are committed to the repository.



### Why this is the "correct" way:
* **Safety:** The `needs: build-and-test` line prevents you from deploying broken code to your users.
* **Efficiency:** Using `go-version-file` means you only ever have to update your Go version in one place (`go.mod`).
* **Portability:** By building a Docker image, your **Groupie Tracker** will run exactly the same on a server as it does on your local machine, avoiding "it works on my machine" errors.

**Would you like me to show you how to pull and run this image on your server once it's built?**
